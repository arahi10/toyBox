# What is this
ぷよぷよのGTRの連鎖尾を全探索して、その結果を諸々の解析に役立てようという魂胆の元書かれたコードです

## 何したの
実際に盤面を作ってみて、連鎖数がマックスになったものを数え上げています。盤面の作り方のルールは先駆者のわたさんの動画のものを参考にしております。

[先駆者のわたさんすばらしいの記事](https://puyo-camp.jp/posts/158147)

## 実行結果
### ファイル
[all.txt](https://github.com/arahi10/toyBox/blob/main/all.txt) (座布団なし)


[all_zabuton.txt](https://github.com/arahi10/toyBox/blob/main/all_zabuton.txt) (座布団あり)

の2ファイル。
### 結果の見方
"同じ"盤面になったパターン数が多い順で並べ替えてあります。
```
(何番目か) : (パターン数)
(連鎖の消える順番を表した盤面)
```
のようなフォーマットになっております。例として
```
38 : 96
111560
234550
223446
334656
```
という解なら、例えば
```
R R R Y R
G Y B Y Y
G G Y B B R
Y Y B R Y R
```
のような実際の盤面に対応しております。(色の情報は入れていませんが悪しからず)

## ファイルをダウンロードしたい人
ページの上の緑色の code のボタンをおして、zip形式でダウンロードするのが一番簡単だと思います。　一緒についてくるpythonファイルは消してしまって構いません。
分かる人は適当にforkなりしてください。
## コードやアルゴリズムに興味がある人向けの解説
### アルゴリズム
基本的には全探索ですが、盤面が完成する前に土台部分が消えてしまう盤面はその時点で探索を終了するという枝刈りを行っています。
### 枝刈りの際の連結判定(/およびぷよ消滅の発生の有無の判定)
Union Find Treeをベースに判定処理を行っています。高々サイズ24の盤面にLink Cut Treeを使うのもな…という気持ちで実装簡単な方をとりました。UF木のできないCut操作についてはUF木のテーブルをUnion操作の前にスナップショットしておいて、探索終わった後それを復元するというナイーブな方法で解決しました…。

今回の枝刈りの条件の下ではUnion操作は高々3要素にしか変更をもたらさないのでテーブル全部コピー＆リストアしなくてもいいですが、プロトタイプということで一つ…。
### 盤面の同型判定の方法
"どの盤面とどの盤面を同一視するか？"という話です。2種類くらい思いつくと思います。
 - 連鎖をシミュレートしておいて、元の盤面のそれぞれのぷよが何連鎖目に消えるかをテーブル形式で計算し、これをキーとする
 - 各色について盤面における出現位置のインデックスをとり、(色に適当に順序付けを行った後)盤面全体として辞書順最小になるように色を振り分ける。振り分け後の盤面をキーとする。

どちらでもよかったですが、連鎖数を判定するのでどうせならと前者をとりました。これゆえ、ログファイルの内容もこれを情報として持たせています。

飽くまで今後の解析に使えるデータを取得するという目的なので、形については同型判定で考えられる方式のうちあまりヒューリスティックを入れない方式でやっています。
### やり残したこと
  - 高速化
    - 扱うデータは全て整数な分、classdefも含めてnumpy.ndarrayに書き換えが原理的には可能です。numbaのjitとか使えそう
    - もう少し枝刈りの方法を賢くやりたい、とは思う
    - ~~そもそも言語選択が~~
  - 解の評価値のブラッシュアップ
    - 解の実行可能性に重きを置いた分、トレードオフとして下位の評価値の有効性がややない
      -  そもそもこの方式で数えると上位個体として、「土台自体の色制約が少ない」解よりも「ごみぷよへの色制約が出ない」解が選ばれがちであるので。
    -  同型判定自体のブラッシュアップもあるかも？
      - 前章最後で話した事情があるので、これは改善点というよりは別のプロジェクトである気もします  
